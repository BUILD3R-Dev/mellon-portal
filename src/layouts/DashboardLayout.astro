---
import '../styles/global.css';
import { db, tenantBranding, tenants } from '@/lib/db';
import { eq, inArray } from 'drizzle-orm';
import { generateCSSRootBlock, getDefaultBrandingVariables } from '@/lib/themes';
import { WorkspaceSelector } from '../components/common/WorkspaceSelector';

interface Props {
  title: string;
}

const { title } = Astro.props;

// Get user and tenant info from locals (set by auth middleware)
const { user, memberships, tenantId, isAgencyAdmin } = Astro.locals;

// Find current tenant name if in tenant context
const currentMembership = memberships?.find((m) => m.tenantId === tenantId);
const tenantName = currentMembership?.tenant?.name || null;

// Check if user has multiple workspaces or is agency admin
const hasMultipleWorkspaces = memberships && memberships.filter((m) => m.tenantId !== null).length > 1;
const showWorkspaceSelector = isAgencyAdmin || hasMultipleWorkspaces;

// Fetch initial tenant list for workspace selector
let initialTenants: { id: string; name: string; status: string }[] = [];
if (showWorkspaceSelector) {
  try {
    if (isAgencyAdmin) {
      // Agency admins can see all active tenants
      const allTenants = await db
        .select({
          id: tenants.id,
          name: tenants.name,
          status: tenants.status,
        })
        .from(tenants)
        .where(eq(tenants.status, 'active'));

      initialTenants = allTenants.sort((a, b) => a.name.localeCompare(b.name));
    } else {
      // Non-agency users can only see their assigned tenants
      const userTenantIds = memberships
        ?.filter((m) => m.tenantId !== null)
        .map((m) => m.tenantId as string) || [];

      if (userTenantIds.length > 0) {
        const userTenants = await db
          .select({
            id: tenants.id,
            name: tenants.name,
            status: tenants.status,
          })
          .from(tenants)
          .where(inArray(tenants.id, userTenantIds));

        initialTenants = userTenants
          .filter((t) => t.status === 'active')
          .sort((a, b) => a.name.localeCompare(b.name));
      }
    }
  } catch (error) {
    console.error('Error fetching tenants for workspace selector:', error);
  }
}

// Fetch tenant branding if in tenant context
let tenantBrandingData = null;
let cssVariables = generateCSSRootBlock('light'); // Default to light theme

if (tenantId) {
  try {
    const brandingResult = await db
      .select({
        tenantLogoUrl: tenantBranding.tenantLogoUrl,
        themeId: tenantBranding.themeId,
        accentColorOverride: tenantBranding.accentColorOverride,
      })
      .from(tenantBranding)
      .where(eq(tenantBranding.tenantId, tenantId))
      .limit(1);

    if (brandingResult.length > 0) {
      tenantBrandingData = brandingResult[0];
      cssVariables = generateCSSRootBlock(
        tenantBrandingData.themeId || 'light',
        tenantBrandingData.accentColorOverride
      );
    }
  } catch (error) {
    console.error('Error fetching tenant branding:', error);
  }
}

const tenantLogoUrl = tenantBrandingData?.tenantLogoUrl;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Mellon Franchising Client Portal" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title} | Mellon Portal</title>
    <!-- Inject CSS custom properties for theming -->
    <style set:html={cssVariables}></style>
  </head>
  <body class="min-h-screen flex flex-col" style="background-color: var(--background, #F9FAFB);">
    <header class="sticky top-0 z-50 w-full border-b backdrop-blur supports-[backdrop-filter]:bg-white/60" style="background-color: var(--background-secondary, #FFFFFF); border-color: var(--border, #E5E7EB);">
      <div class="container mx-auto flex h-16 items-center justify-between px-4">
        <div class="flex items-center gap-4">
          <!-- Tenant logo or Mellon Portal text -->
          {tenantLogoUrl ? (
            <a href="/dashboard" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
              <img
                src={tenantLogoUrl}
                alt={tenantName ? `${tenantName} logo` : 'Tenant logo'}
                class="h-8 md:h-10 max-w-[160px] object-contain"
              />
              <span class="hidden lg:inline-flex h-6 w-px bg-gray-200"></span>
              <span class="hidden lg:inline text-sm font-medium" style="color: var(--foreground-muted, #6B7280);">
                Mellon Portal
              </span>
            </a>
          ) : (
            <a href="/dashboard" class="text-xl font-semibold transition-colors" style="color: var(--foreground, #111827);">
              Mellon Portal
            </a>
          )}
          {tenantName && !tenantLogoUrl && (
            <span class="hidden sm:inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" style="background-color: var(--border-muted, #F3F4F6); color: var(--foreground, #111827);">
              {tenantName}
            </span>
          )}
        </div>

        <nav class="hidden md:flex items-center gap-6">
          <a href="/dashboard" class="text-sm font-medium transition-colors hover:opacity-80" style="color: var(--foreground-muted, #6B7280);">Dashboard</a>
          <a href="/reports" class="text-sm font-medium transition-colors hover:opacity-80" style="color: var(--foreground-muted, #6B7280);">Reports</a>
          <a href="/leads" class="text-sm font-medium transition-colors hover:opacity-80" style="color: var(--foreground-muted, #6B7280);">Leads</a>
          <a href="/pipeline" class="text-sm font-medium transition-colors hover:opacity-80" style="color: var(--foreground-muted, #6B7280);">Pipeline</a>
          <a href="/hot-list" class="text-sm font-medium transition-colors hover:opacity-80" style="color: var(--foreground-muted, #6B7280);">Hot List</a>
          {isAgencyAdmin && (
            <>
              <span class="h-4 w-px" style="background-color: var(--border, #E5E7EB);"></span>
              <a href="/admin/tenants" class="text-sm font-medium transition-colors hover:opacity-80" style="color: var(--foreground-muted, #6B7280);">Tenants</a>
              <a href="/admin/users" class="text-sm font-medium transition-colors hover:opacity-80" style="color: var(--foreground-muted, #6B7280);">Users</a>
              <a href="/admin/dashboard" class="text-sm font-medium transition-colors hover:opacity-80" style="color: var(--foreground-muted, #6B7280);">Admin</a>
            </>
          )}
        </nav>

        <div class="flex items-center gap-3">
          <!-- Workspace Selector -->
          {showWorkspaceSelector && (
            <WorkspaceSelector
              client:load
              currentTenantId={tenantId || null}
              currentTenantName={tenantName}
              isAgencyAdmin={isAgencyAdmin || false}
              initialTenants={initialTenants}
            />
          )}

          <!-- User info and actions dropdown -->
          <div class="relative" id="user-menu">
            <button
              type="button"
              id="user-menu-button"
              class="flex items-center gap-2 text-sm rounded-lg px-2 py-1 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2"
              style="color: var(--foreground, #111827); --tw-ring-color: var(--accent-color, #2563EB);"
              aria-expanded="false"
              aria-haspopup="true"
            >
              <span class="hidden sm:inline">{user?.name || user?.email || 'User'}</span>
              <svg
                class="h-5 w-5"
                style="color: var(--foreground-muted, #9CA3AF);"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                aria-hidden="true"
              >
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </button>

            <!-- Dropdown menu -->
            <div
              id="user-dropdown"
              class="hidden absolute right-0 mt-2 w-56 origin-top-right rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
              style="background-color: var(--card-background, #FFFFFF);"
              role="menu"
              aria-orientation="vertical"
              aria-labelledby="user-menu-button"
            >
              <div class="py-1">
                <!-- User info -->
                <div class="px-4 py-3 border-b" style="border-color: var(--border-muted, #F3F4F6);">
                  <p class="text-sm font-medium" style="color: var(--foreground, #111827);">{user?.name || 'User'}</p>
                  <p class="text-xs truncate" style="color: var(--foreground-muted, #6B7280);">{user?.email}</p>
                </div>

                <!-- Profile link -->
                <a
                  href="/profile"
                  class="block px-4 py-2 text-sm transition-colors hover:bg-gray-50"
                  style="color: var(--foreground, #111827);"
                  role="menuitem"
                >
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Profile settings
                  </div>
                </a>

                <!-- Switch workspace link (only if multiple workspaces) -->
                {hasMultipleWorkspaces && (
                  <a
                    href="/select-workspace"
                    class="block px-4 py-2 text-sm transition-colors hover:bg-gray-50"
                    style="color: var(--foreground, #111827);"
                    role="menuitem"
                  >
                    <div class="flex items-center gap-2">
                      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                      </svg>
                      Switch workspace
                    </div>
                  </a>
                )}

                <div class="border-t my-1" style="border-color: var(--border-muted, #F3F4F6);"></div>

                <!-- Logout button -->
                <button
                  type="button"
                  id="logout-button"
                  class="w-full text-left px-4 py-2 text-sm transition-colors hover:bg-gray-50"
                  style="color: var(--foreground, #111827);"
                  role="menuitem"
                >
                  <div class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Sign out
                  </div>
                </button>
              </div>
            </div>
          </div>

          <!-- Mobile menu button -->
          <button
            type="button"
            id="mobile-menu-button"
            class="md:hidden inline-flex items-center justify-center p-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-inset"
            style="color: var(--foreground-muted, #9CA3AF); --tw-ring-color: var(--accent-color, #2563EB);"
            aria-expanded="false"
          >
            <span class="sr-only">Open main menu</span>
            <svg
              class="h-6 w-6"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              aria-hidden="true"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Mobile navigation menu -->
      <div id="mobile-menu" class="hidden md:hidden border-t" style="border-color: var(--border, #E5E7EB);">
        <div class="px-4 py-3 space-y-1">
          <a href="/dashboard" class="block px-3 py-2 text-base font-medium rounded-lg transition-colors" style="color: var(--foreground-muted, #6B7280);">Dashboard</a>
          <a href="/reports" class="block px-3 py-2 text-base font-medium rounded-lg transition-colors" style="color: var(--foreground-muted, #6B7280);">Reports</a>
          <a href="/leads" class="block px-3 py-2 text-base font-medium rounded-lg transition-colors" style="color: var(--foreground-muted, #6B7280);">Leads</a>
          <a href="/pipeline" class="block px-3 py-2 text-base font-medium rounded-lg transition-colors" style="color: var(--foreground-muted, #6B7280);">Pipeline</a>
          <a href="/hot-list" class="block px-3 py-2 text-base font-medium rounded-lg transition-colors" style="color: var(--foreground-muted, #6B7280);">Hot List</a>
          <div class="my-2 border-t" style="border-color: var(--border, #E5E7EB);"></div>
          <a href="/profile" class="block px-3 py-2 text-base font-medium rounded-lg transition-colors" style="color: var(--foreground-muted, #6B7280);">Profile</a>
          {isAgencyAdmin && (
            <>
              <div class="my-2 border-t" style="border-color: var(--border, #E5E7EB);"></div>
              <a href="/admin/tenants" class="block px-3 py-2 text-base font-medium rounded-lg transition-colors" style="color: var(--foreground-muted, #6B7280);">Tenants</a>
              <a href="/admin/users" class="block px-3 py-2 text-base font-medium rounded-lg transition-colors" style="color: var(--foreground-muted, #6B7280);">Users</a>
              <a href="/admin/dashboard" class="block px-3 py-2 text-base font-medium rounded-lg transition-colors" style="color: var(--foreground-muted, #6B7280);">Admin</a>
            </>
          )}
        </div>
      </div>
    </header>

    <main class="container mx-auto px-4 py-8 flex-1">
      <slot />
    </main>

    <!-- Co-branded footer -->
    <footer class="border-t py-6" style="background-color: var(--background-secondary, #FFFFFF); border-color: var(--border, #E5E7EB);">
      <div class="container mx-auto px-4">
        <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
          <div class="flex items-center gap-2">
            <span class="text-sm" style="color: var(--foreground-muted, #6B7280);">Powered by</span>
            <span class="text-sm font-semibold" style="color: var(--accent-color, #2563EB);">Mellon Franchising</span>
          </div>
          <span class="hidden sm:inline h-4 w-px" style="background-color: var(--border, #E5E7EB);"></span>
          <span class="text-xs" style="color: var(--foreground-muted, #9CA3AF);">
            &copy; {new Date().getFullYear()} Mellon Franchising. All rights reserved.
          </span>
        </div>
      </div>
    </footer>
  </body>
</html>

<script>
  // User dropdown toggle
  const userMenuButton = document.getElementById('user-menu-button');
  const userDropdown = document.getElementById('user-dropdown');
  const logoutButton = document.getElementById('logout-button');
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');

  let isUserDropdownOpen = false;
  let isMobileMenuOpen = false;

  /**
   * Toggles the user dropdown menu
   */
  function toggleUserDropdown(): void {
    isUserDropdownOpen = !isUserDropdownOpen;
    userDropdown?.classList.toggle('hidden', !isUserDropdownOpen);
    userMenuButton?.setAttribute('aria-expanded', String(isUserDropdownOpen));
  }

  /**
   * Closes the user dropdown menu
   */
  function closeUserDropdown(): void {
    isUserDropdownOpen = false;
    userDropdown?.classList.add('hidden');
    userMenuButton?.setAttribute('aria-expanded', 'false');
  }

  /**
   * Toggles the mobile menu
   */
  function toggleMobileMenu(): void {
    isMobileMenuOpen = !isMobileMenuOpen;
    mobileMenu?.classList.toggle('hidden', !isMobileMenuOpen);
    mobileMenuButton?.setAttribute('aria-expanded', String(isMobileMenuOpen));
  }

  /**
   * Handles logout
   */
  async function handleLogout(): Promise<void> {
    if (logoutButton) {
      logoutButton.textContent = 'Signing out...';
      logoutButton.setAttribute('disabled', 'true');
    }

    try {
      await fetch('/api/auth/logout', {
        method: 'POST',
      });

      // Redirect to login page regardless of response
      window.location.href = '/login';
    } catch (error) {
      console.error('Logout error:', error);
      window.location.href = '/login';
    }
  }

  // Event listeners
  userMenuButton?.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleUserDropdown();
  });

  logoutButton?.addEventListener('click', handleLogout);

  mobileMenuButton?.addEventListener('click', toggleMobileMenu);

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    const target = e.target as Node;
    const userMenu = document.getElementById('user-menu');
    if (userMenu && !userMenu.contains(target)) {
      closeUserDropdown();
    }
  });

  // Close dropdown on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeUserDropdown();
    }
  });
</script>
