---
import DashboardLayout from '../../../../layouts/DashboardLayout.astro';
import { TenantUserManagement } from '../../../../components/admin/TenantUserManagement';
import { db, tenants, memberships, users } from '@/lib/db';
import { eq } from 'drizzle-orm';

// This page is protected by middleware
const { user, memberships: userMemberships, isAgencyAdmin, isTenantAdmin } = Astro.locals;

// Get tenant ID from URL params
const { id: tenantId } = Astro.params;

if (!tenantId) {
  return Astro.redirect('/admin/tenants');
}

// Check authorization - requires Tenant Admin for this tenant OR Agency Admin
const hasTenantAccess =
  isAgencyAdmin ||
  userMemberships?.some((m) => m.role === 'tenant_admin' && m.tenantId === tenantId);

if (!hasTenantAccess) {
  return Astro.redirect('/dashboard');
}

// Fetch tenant details
const [tenant] = await db
  .select({
    id: tenants.id,
    name: tenants.name,
    status: tenants.status,
  })
  .from(tenants)
  .where(eq(tenants.id, tenantId))
  .limit(1);

if (!tenant) {
  return Astro.redirect('/admin/tenants');
}

// Fetch users for this tenant
const tenantUsers = await db
  .select({
    id: users.id,
    email: users.email,
    name: users.name,
    role: memberships.role,
    status: users.status,
    createdAt: users.createdAt,
  })
  .from(memberships)
  .innerJoin(users, eq(memberships.userId, users.id))
  .where(eq(memberships.tenantId, tenantId));

// Transform data for the component
const usersData = tenantUsers.map((u) => ({
  id: u.id,
  email: u.email,
  name: u.name,
  role: u.role,
  status: u.status,
  createdAt: u.createdAt.toISOString(),
}));

// Determine user's role for the component
const userRole = isAgencyAdmin ? 'agency_admin' : 'tenant_admin';
---

<DashboardLayout title={`Users - ${tenant.name}`}>
  <div class="space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm text-gray-500">
      {isAgencyAdmin && (
        <>
          <a href="/admin/dashboard" class="hover:text-gray-700">Admin</a>
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
          <a href="/admin/tenants" class="hover:text-gray-700">Tenants</a>
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
          <span class="text-gray-700">{tenant.name}</span>
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </>
      )}
      <span class="text-gray-900 font-medium">Users</span>
    </nav>

    <TenantUserManagement
      client:load
      tenantId={tenantId}
      tenantName={tenant.name}
      initialUsers={usersData}
      userRole={userRole}
    />
  </div>
</DashboardLayout>
