---
import DashboardLayout from '../../../../layouts/DashboardLayout.astro';
import { TenantDetail } from '../../../../components/admin/TenantDetail';
import { db, tenants, tenantBranding, memberships, users } from '@/lib/db';
import { eq, sql } from 'drizzle-orm';

// This page is protected by middleware
const { user, memberships: userMemberships } = Astro.locals;

// Verify user is agency admin
const isAgencyAdmin = userMemberships?.some((m) => m.role === 'agency_admin' && m.tenantId === null);

if (!isAgencyAdmin) {
  return Astro.redirect('/dashboard');
}

// Get tenant ID from URL params
const { id: tenantId } = Astro.params;

if (!tenantId) {
  return Astro.redirect('/admin/tenants');
}

// Fetch tenant with branding data
const result = await db
  .select({
    id: tenants.id,
    name: tenants.name,
    status: tenants.status,
    timezone: tenants.timezone,
    createdAt: tenants.createdAt,
    updatedAt: tenants.updatedAt,
    brandingId: tenantBranding.id,
    themeId: tenantBranding.themeId,
    accentColorOverride: tenantBranding.accentColorOverride,
    tenantLogoUrl: tenantBranding.tenantLogoUrl,
    mellonLogoUrl: tenantBranding.mellonLogoUrl,
    primaryColor: tenantBranding.primaryColor,
    accentColor: tenantBranding.accentColor,
  })
  .from(tenants)
  .leftJoin(tenantBranding, eq(tenants.id, tenantBranding.tenantId))
  .where(eq(tenants.id, tenantId))
  .limit(1);

if (result.length === 0) {
  return Astro.redirect('/admin/tenants');
}

const tenant = result[0];

// Get user count for this tenant
const userCountResult = await db
  .select({ count: sql<number>`count(*)::int` })
  .from(memberships)
  .where(eq(memberships.tenantId, tenantId));

const userCount = userCountResult[0]?.count || 0;

// Fetch users associated with this tenant
const tenantUsers = await db
  .select({
    id: users.id,
    email: users.email,
    name: users.name,
    role: memberships.role,
  })
  .from(memberships)
  .innerJoin(users, eq(memberships.userId, users.id))
  .where(eq(memberships.tenantId, tenantId))
  .orderBy(users.email);

const tenantData = {
  id: tenant.id,
  name: tenant.name,
  status: tenant.status as 'active' | 'inactive' | 'suspended',
  timezone: tenant.timezone,
  createdAt: tenant.createdAt.toISOString(),
  updatedAt: tenant.updatedAt.toISOString(),
  userCount,
  branding: tenant.brandingId
    ? {
        id: tenant.brandingId,
        themeId: tenant.themeId || 'light',
        accentColorOverride: tenant.accentColorOverride,
        tenantLogoUrl: tenant.tenantLogoUrl,
        mellonLogoUrl: tenant.mellonLogoUrl,
        primaryColor: tenant.primaryColor,
        accentColor: tenant.accentColor,
      }
    : null,
};

const usersData = tenantUsers.map((u) => ({
  id: u.id,
  email: u.email,
  name: u.name,
  role: u.role,
}));
---

<DashboardLayout title={`Tenant - ${tenant.name}`}>
  <div class="space-y-6">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm text-gray-500">
      <a href="/admin/dashboard" class="hover:text-gray-700">Admin</a>
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
      <a href="/admin/tenants" class="hover:text-gray-700">Tenants</a>
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
      <span class="text-gray-900 font-medium">{tenant.name}</span>
    </nav>

    <TenantDetail
      client:load
      tenant={tenantData}
      users={usersData}
    />
  </div>
</DashboardLayout>
