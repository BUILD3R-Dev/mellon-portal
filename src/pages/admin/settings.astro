---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { BrandingSettings } from '../../components/admin/BrandingSettings';
import { db, portalBranding } from '@/lib/db';

// This page is protected by middleware
const { user, memberships } = Astro.locals;

// Verify user is agency admin
const isAgencyAdmin = memberships?.some((m) => m.role === 'agency_admin' && m.tenantId === null);

if (!isAgencyAdmin) {
  return Astro.redirect('/dashboard');
}

// Fetch or create portal branding
let branding;
try {
  const rows = await db.select().from(portalBranding).limit(1);
  if (rows.length > 0) {
    branding = rows[0];
  } else {
    const inserted = await db.insert(portalBranding).values({}).returning();
    branding = inserted[0];
  }
} catch (error) {
  console.error('Error fetching portal branding:', error);
  branding = {
    id: '',
    headerLogoLightUrl: null,
    headerLogoDarkUrl: null,
    footerLogoLightUrl: null,
    footerLogoDarkUrl: null,
    faviconUrl: null,
    adminThemeId: 'light',
    updatedAt: new Date(),
  };
}
---

<DashboardLayout title="Branding">
  <BrandingSettings client:load initialBranding={branding} />
</DashboardLayout>
