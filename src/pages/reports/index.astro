---
/**
 * Reports List Page
 *
 * Displays a paginated list of published reports for the current tenant user.
 * Features the "Latest Report" prominently at the top.
 * Includes year/month filters and optional PDF download buttons.
 * Requires authenticated user with tenant membership.
 */
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { ReportsList } from '@/components/reports/ReportsList';
import { isFeatureEnabled, FEATURE_PDF_EXPORT } from '@/lib/feature-flags';

// Get user and tenant context from middleware
const { user, memberships, tenantId, isAgencyAdmin } = Astro.locals;

// Require authenticated user with tenant context
if (!user) {
  return Astro.redirect('/login');
}

if (!tenantId) {
  // No tenant context selected - redirect to dashboard
  return Astro.redirect('/dashboard');
}

// Verify user has access to this tenant
const hasTenantAccess = isAgencyAdmin || memberships?.some((m) => m.tenantId === tenantId);

if (!hasTenantAccess) {
  return Astro.redirect('/dashboard');
}

// Check if PDF export feature is enabled for this tenant
const pdfExportEnabled = await isFeatureEnabled(tenantId, FEATURE_PDF_EXPORT);
---

<DashboardLayout title="Reports">
  <div class="max-w-4xl mx-auto space-y-6">
    <!-- Page header -->
    <div>
      <h1 class="text-2xl font-semibold text-gray-900">Reports</h1>
      <p class="mt-1 text-gray-600">View your weekly marketing reports</p>
    </div>

    <!-- Reports list -->
    <ReportsList client:load pdfExportEnabled={pdfExportEnabled} />
  </div>
</DashboardLayout>
