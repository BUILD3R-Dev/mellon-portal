---
/**
 * Notes Dashboard Page
 *
 * Displays recent notes with date, author, and content preview.
 * Includes text search filter and load more pagination.
 */
import DashboardLayout from '../layouts/DashboardLayout.astro';
import { SyncStatusBanner } from '../components/dashboard/SyncStatusBanner';
import { db, ctNotes } from '@/lib/db';
import { eq, desc, or, ilike } from 'drizzle-orm';

// Get tenant context from locals (set by middleware)
const { tenantId } = Astro.locals;

// Get search query from URL params
const searchQuery = Astro.url.searchParams.get('search') || '';

// Query notes for current tenant
let notes: Array<{
  id: string;
  noteDate: Date;
  author: string | null;
  content: string | null;
}> = [];

if (tenantId) {
  try {
    let query = db
      .select({
        id: ctNotes.id,
        noteDate: ctNotes.noteDate,
        author: ctNotes.author,
        content: ctNotes.content,
      })
      .from(ctNotes)
      .where(eq(ctNotes.tenantId, tenantId))
      .orderBy(desc(ctNotes.noteDate))
      .limit(50);

    // Note: search filtering is done client-side via React component for "Load More" pattern
    notes = await query;
  } catch (error) {
    console.error('Error fetching notes:', error);
  }
}

// Format date
function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(date);
}

// Truncate content for preview
function truncateContent(content: string | null, maxLength: number = 150): string {
  if (!content) return 'No content';
  if (content.length <= maxLength) return content;
  return content.substring(0, maxLength) + '...';
}

// Prepare initial data for client-side component
const initialNotes = notes.map((note) => ({
  id: note.id,
  noteDate: note.noteDate.toISOString(),
  author: note.author,
  content: note.content,
}));
---

<DashboardLayout title="Notes">
  <div class="space-y-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900">Notes</h1>
        <p class="mt-1 text-gray-600">Recent notes and communications.</p>
      </div>
    </div>

    <!-- Search Filter -->
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <form method="get" class="flex gap-4">
        <div class="flex-1">
          <label for="search" class="sr-only">Search notes</label>
          <input
            type="text"
            id="search"
            name="search"
            value={searchQuery}
            placeholder="Search by content or author..."
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors"
          />
        </div>
        <button
          type="submit"
          class="px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-gray-800 transition-colors"
        >
          Search
        </button>
      </form>
    </div>

    <!-- Notes List -->
    <div class="space-y-4" id="notes-list">
      {notes.length > 0 ? (
        notes.map((note) => (
          <div class="bg-white rounded-xl border border-gray-200 p-6 note-item" data-content={note.content?.toLowerCase()} data-author={note.author?.toLowerCase()}>
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-sm font-medium text-gray-900">
                    {note.author || 'Unknown Author'}
                  </span>
                  <span class="text-sm text-gray-500">
                    {formatDate(note.noteDate)}
                  </span>
                </div>
                <p class="text-sm text-gray-600 whitespace-pre-wrap">
                  {truncateContent(note.content)}
                </p>
              </div>
            </div>
          </div>
        ))
      ) : (
        <div class="bg-white rounded-xl border border-gray-200 p-8 text-center text-gray-500">
          No notes available
        </div>
      )}
    </div>

    <!-- Load More Button (client-side pagination) -->
    {notes.length >= 50 && (
      <div class="text-center">
        <button
          type="button"
          id="load-more-btn"
          class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
          data-offset="50"
        >
          Load More
        </button>
      </div>
    )}

    <!-- Data Freshness Banner -->
    <SyncStatusBanner client:load />
  </div>
</DashboardLayout>

<script>
  // Client-side search filtering
  const searchInput = document.getElementById('search') as HTMLInputElement;
  const notesList = document.getElementById('notes-list');
  const loadMoreBtn = document.getElementById('load-more-btn');

  // Filter notes on input (for quick client-side filtering)
  searchInput?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.toLowerCase();
    const noteItems = document.querySelectorAll('.note-item');

    noteItems.forEach((item) => {
      const content = item.getAttribute('data-content') || '';
      const author = item.getAttribute('data-author') || '';

      if (content.includes(query) || author.includes(query)) {
        (item as HTMLElement).style.display = '';
      } else {
        (item as HTMLElement).style.display = 'none';
      }
    });
  });

  // Load more functionality
  loadMoreBtn?.addEventListener('click', async () => {
    const offset = parseInt(loadMoreBtn.getAttribute('data-offset') || '50', 10);

    try {
      loadMoreBtn.textContent = 'Loading...';
      loadMoreBtn.setAttribute('disabled', 'true');

      const response = await fetch(`/api/dashboard/notes?offset=${offset}&limit=50`);
      const result = await response.json();

      if (result.success && result.data.notes.length > 0) {
        const notes = result.data.notes;

        // Append new notes to the list
        notes.forEach((note: { id: string; noteDate: string; author: string | null; content: string | null }) => {
          const noteEl = document.createElement('div');
          noteEl.className = 'bg-white rounded-xl border border-gray-200 p-6 note-item';
          noteEl.setAttribute('data-content', (note.content || '').toLowerCase());
          noteEl.setAttribute('data-author', (note.author || '').toLowerCase());

          const date = new Date(note.noteDate);
          const formattedDate = new Intl.DateTimeFormat('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          }).format(date);

          const truncatedContent = note.content
            ? note.content.length > 150
              ? note.content.substring(0, 150) + '...'
              : note.content
            : 'No content';

          noteEl.innerHTML = `
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-sm font-medium text-gray-900">
                    ${note.author || 'Unknown Author'}
                  </span>
                  <span class="text-sm text-gray-500">
                    ${formattedDate}
                  </span>
                </div>
                <p class="text-sm text-gray-600 whitespace-pre-wrap">
                  ${truncatedContent}
                </p>
              </div>
            </div>
          `;

          notesList?.appendChild(noteEl);
        });

        // Update offset for next load
        loadMoreBtn.setAttribute('data-offset', String(offset + 50));
        loadMoreBtn.textContent = 'Load More';
        loadMoreBtn.removeAttribute('disabled');

        // Hide button if no more notes
        if (notes.length < 50) {
          loadMoreBtn.style.display = 'none';
        }
      } else {
        loadMoreBtn.style.display = 'none';
      }
    } catch (error) {
      console.error('Error loading more notes:', error);
      loadMoreBtn.textContent = 'Load More';
      loadMoreBtn.removeAttribute('disabled');
    }
  });
</script>
