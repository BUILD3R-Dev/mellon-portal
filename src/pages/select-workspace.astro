---
import Layout from '../layouts/Layout.astro';

// This page is protected by middleware, so we can safely access locals
const { user, memberships } = Astro.locals;

// Filter to only tenant memberships (exclude agency admin memberships)
const tenantMemberships = memberships?.filter((m) => m.tenantId !== null) || [];

// Role display names
const roleLabels: Record<string, string> = {
  tenant_admin: 'Admin',
  tenant_viewer: 'Viewer',
  agency_admin: 'Agency Admin',
};
---

<Layout title="Select Workspace">
  <main class="min-h-screen flex items-center justify-center bg-gray-50">
    <div class="w-full max-w-lg px-4">
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
        <div class="text-center mb-8">
          <h1 class="text-2xl font-semibold text-gray-900">Select a Workspace</h1>
          <p class="mt-2 text-gray-600">
            Welcome{user?.name ? `, ${user.name}` : ''}. Choose which workspace you'd like to access.
          </p>
        </div>

        <!-- Error message container -->
        <div
          id="error-container"
          class="hidden mb-6 p-4 rounded-lg bg-red-50 border border-red-200"
          role="alert"
          aria-live="polite"
        >
          <p id="error-message" class="text-sm text-red-700"></p>
        </div>

        {
          tenantMemberships.length === 0 ? (
            <div class="text-center py-8">
              <p class="text-gray-500">No workspaces available.</p>
              <p class="text-sm text-gray-400 mt-2">
                Please contact your administrator if you believe this is an error.
              </p>
            </div>
          ) : (
            <div class="space-y-3" role="list" aria-label="Available workspaces">
              {tenantMemberships.map((membership) => (
                <button
                  type="button"
                  class="workspace-item w-full p-4 text-left rounded-lg border border-gray-200 hover:border-gray-400 hover:bg-gray-50 transition-all focus:outline-none focus:ring-2 focus:ring-gray-900 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
                  data-tenant-id={membership.tenantId}
                  data-tenant-name={membership.tenant?.name}
                >
                  <div class="flex items-center justify-between">
                    <div>
                      <h3 class="font-medium text-gray-900">
                        {membership.tenant?.name || 'Unknown Workspace'}
                      </h3>
                      <p class="text-sm text-gray-500 mt-0.5">
                        {roleLabels[membership.role] || membership.role}
                      </p>
                    </div>
                    <svg
                      class="h-5 w-5 text-gray-400"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      aria-hidden="true"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"
                      />
                    </svg>
                  </div>
                </button>
              ))}
            </div>
          )
        }

        <div class="mt-8 pt-6 border-t border-gray-200">
          <button
            type="button"
            id="logout-button"
            class="w-full px-4 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors"
          >
            Sign out and use a different account
          </button>
        </div>
      </div>
    </div>
  </main>
</Layout>

<script>
  const workspaceItems = document.querySelectorAll('.workspace-item');
  const errorContainer = document.getElementById('error-container') as HTMLDivElement;
  const errorMessage = document.getElementById('error-message') as HTMLParagraphElement;
  const logoutButton = document.getElementById('logout-button') as HTMLButtonElement;

  /**
   * Shows an error message to the user
   */
  function showError(message: string): void {
    errorMessage.textContent = message;
    errorContainer.classList.remove('hidden');
  }

  /**
   * Hides the error message
   */
  function hideError(): void {
    errorContainer.classList.add('hidden');
    errorMessage.textContent = '';
  }

  /**
   * Sets all workspace buttons to disabled state
   */
  function setAllButtonsDisabled(disabled: boolean): void {
    workspaceItems.forEach((item) => {
      (item as HTMLButtonElement).disabled = disabled;
    });
  }

  /**
   * Handles workspace selection
   */
  async function handleWorkspaceSelect(event: Event): Promise<void> {
    const button = event.currentTarget as HTMLButtonElement;
    const tenantId = button.dataset.tenantId;
    const tenantName = button.dataset.tenantName;

    if (!tenantId) {
      showError('Invalid workspace selection');
      return;
    }

    hideError();
    setAllButtonsDisabled(true);

    // Add loading indicator to selected button
    const originalContent = button.innerHTML;
    button.innerHTML = `
      <div class="flex items-center justify-center gap-2">
        <svg class="animate-spin h-5 w-5 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Loading ${tenantName || 'workspace'}...</span>
      </div>
    `;

    try {
      const response = await fetch('/api/auth/set-workspace', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ tenantId }),
      });

      const data = await response.json();

      if (!response.ok || !data.success) {
        button.innerHTML = originalContent;
        setAllButtonsDisabled(false);
        showError(data.error || 'Failed to select workspace. Please try again.');
        return;
      }

      // Success - redirect to dashboard
      window.location.href = data.redirectUrl || '/dashboard';
    } catch (error) {
      console.error('Workspace selection error:', error);
      button.innerHTML = originalContent;
      setAllButtonsDisabled(false);
      showError('A network error occurred. Please try again.');
    }
  }

  /**
   * Handles logout
   */
  async function handleLogout(): Promise<void> {
    logoutButton.disabled = true;
    logoutButton.textContent = 'Signing out...';

    try {
      await fetch('/api/auth/logout', {
        method: 'POST',
      });

      // Redirect to login page regardless of response
      window.location.href = '/login';
    } catch (error) {
      console.error('Logout error:', error);
      window.location.href = '/login';
    }
  }

  // Attach event listeners
  workspaceItems.forEach((item) => {
    item.addEventListener('click', handleWorkspaceSelect);
  });

  logoutButton.addEventListener('click', handleLogout);
</script>
